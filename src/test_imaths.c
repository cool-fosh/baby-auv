/* (C) 2019 Harold Tay GPLv3 */
#include <avr/io.h>
#include <avr/sleep.h>
#include <avr/interrupt.h>
#include <util/delay.h>
#include "imaths.h"
#include "tx.h"
#include "time.h"

struct xy { int16_t x, y; } tantab[] = {
  { 1024, 0 },
  { 1023, 25 },
  { 1022, 50 },
  { 1021, 75 },
  { 1019, 100 },
  { 1016, 125 },
  { 1012, 150 },
  { 1008, 175 },
  { 1004, 199 },
  { 999, 224 },
  { 993, 248 },
  { 986, 273 },
  { 979, 297 },
  { 972, 321 },
  { 964, 344 },
  { 955, 368 },
  { 946, 391 },
  { 936, 414 },
  { 925, 437 },
  { 914, 460 },
  { 903, 482 },
  { 890, 504 },
  { 878, 526 },
  { 865, 547 },
  { 851, 568 },
  { 837, 589 },
  { 822, 609 },
  { 807, 629 },
  { 791, 649 },
  { 775, 668 },
  { 758, 687 },
  { 741, 706 },
  { 724, 724 },
  { 706, 741 },
  { 687, 758 },
  { 668, 775 },
  { 649, 791 },
  { 629, 807 },
  { 609, 822 },
  { 589, 837 },
  { 568, 851 },
  { 547, 865 },
  { 526, 878 },
  { 504, 890 },
  { 482, 903 },
  { 460, 914 },
  { 437, 925 },
  { 414, 936 },
  { 391, 946 },
  { 368, 955 },
  { 344, 964 },
  { 321, 972 },
  { 297, 979 },
  { 273, 986 },
  { 248, 993 },
  { 224, 999 },
  { 199, 1004 },
  { 175, 1008 },
  { 150, 1012 },
  { 125, 1016 },
  { 100, 1019 },
  { 75, 1021 },
  { 50, 1022 },
  { 25, 1023 },
  { 6, 1024 },
  { -25, 1023 },
  { -50, 1022 },
  { -75, 1021 },
  { -100, 1019 },
  { -125, 1016 },
  { -150, 1012 },
  { -175, 1008 },
  { -199, 1004 },
  { -224, 999 },
  { -248, 993 },
  { -273, 986 },
  { -297, 979 },
  { -321, 972 },
  { -344, 964 },
  { -368, 955 },
  { -391, 946 },
  { -414, 936 },
  { -437, 925 },
  { -460, 914 },
  { -482, 903 },
  { -504, 890 },
  { -526, 878 },
  { -547, 865 },
  { -568, 851 },
  { -589, 837 },
  { -609, 822 },
  { -629, 807 },
  { -649, 791 },
  { -668, 775 },
  { -687, 758 },
  { -706, 741 },
  { -724, 724 },
  { -741, 706 },
  { -758, 687 },
  { -775, 668 },
  { -791, 649 },
  { -807, 629 },
  { -822, 609 },
  { -837, 589 },
  { -851, 568 },
  { -865, 547 },
  { -878, 526 },
  { -890, 504 },
  { -903, 482 },
  { -914, 460 },
  { -925, 437 },
  { -936, 414 },
  { -946, 391 },
  { -955, 368 },
  { -964, 344 },
  { -972, 321 },
  { -979, 297 },
  { -986, 273 },
  { -993, 248 },
  { -999, 224 },
  { -1004, 199 },
  { -1008, 175 },
  { -1012, 150 },
  { -1016, 125 },
  { -1019, 100 },
  { -1021, 75 },
  { -1022, 50 },
  { -1023, 25 },
  { -1024, 1 },
  { -1023, -25 },
  { -1022, -50 },
  { -1021, -75 },
  { -1019, -100 },
  { -1016, -125 },
  { -1012, -150 },
  { -1008, -175 },
  { -1004, -199 },
  { -999, -224 },
  { -993, -248 },
  { -986, -273 },
  { -979, -297 },
  { -972, -321 },
  { -964, -344 },
  { -955, -368 },
  { -946, -391 },
  { -936, -414 },
  { -925, -437 },
  { -914, -460 },
  { -903, -482 },
  { -890, -504 },
  { -878, -526 },
  { -865, -547 },
  { -851, -568 },
  { -837, -589 },
  { -822, -609 },
  { -807, -629 },
  { -791, -649 },
  { -775, -668 },
  { -758, -687 },
  { -741, -706 },
  { -724, -724 },
  { -706, -741 },
  { -687, -758 },
  { -668, -775 },
  { -649, -791 },
  { -629, -807 },
  { -609, -822 },
  { -589, -837 },
  { -568, -851 },
  { -547, -865 },
  { -526, -878 },
  { -504, -890 },
  { -482, -903 },
  { -460, -914 },
  { -437, -925 },
  { -414, -936 },
  { -391, -946 },
  { -368, -955 },
  { -344, -964 },
  { -321, -972 },
  { -297, -979 },
  { -273, -986 },
  { -248, -993 },
  { -224, -999 },
  { -199, -1004 },
  { -175, -1008 },
  { -150, -1012 },
  { -125, -1016 },
  { -100, -1019 },
  { -75, -1021 },
  { -50, -1022 },
  { -25, -1023 },
  { -1, -1024 },
  { 25, -1023 },
  { 50, -1022 },
  { 75, -1021 },
  { 100, -1019 },
  { 125, -1016 },
  { 150, -1012 },
  { 175, -1008 },
  { 199, -1004 },
  { 224, -999 },
  { 248, -993 },
  { 273, -986 },
  { 297, -979 },
  { 321, -972 },
  { 344, -964 },
  { 368, -955 },
  { 391, -946 },
  { 414, -936 },
  { 437, -925 },
  { 460, -914 },
  { 482, -903 },
  { 504, -890 },
  { 526, -878 },
  { 547, -865 },
  { 568, -851 },
  { 589, -837 },
  { 609, -822 },
  { 629, -807 },
  { 649, -791 },
  { 668, -775 },
  { 687, -758 },
  { 706, -741 },
  { 724, -724 },
  { 741, -706 },
  { 758, -687 },
  { 775, -668 },
  { 791, -649 },
  { 807, -629 },
  { 822, -609 },
  { 837, -589 },
  { 851, -568 },
  { 865, -547 },
  { 878, -526 },
  { 890, -504 },
  { 903, -482 },
  { 914, -460 },
  { 925, -437 },
  { 936, -414 },
  { 946, -391 },
  { 955, -368 },
  { 964, -344 },
  { 972, -321 },
  { 979, -297 },
  { 986, -273 },
  { 993, -248 },
  { 999, -224 },
  { 1004, -199 },
  { 1008, -175 },
  { 1012, -150 },
  { 1016, -125 },
  { 1019, -100 },
  { 1021, -75 },
  { 1022, -50 },
  { 1023, -25 },
};

#define TEST_PROFILE(type, arg) \
{ uint16_t s, e; type r; sleep_mode(); tx_puts(#arg); \
s = TCNT1; r = arg; e = TCNT1; \
tx_puts( " = "); tx_putdec(r); tx_msg(", elapsed = ", e - s); }


static int16_t delay(void) { _delay_us(100); return(0); }

int
main(void)
{
  uint16_t angle;

  tx_init();
  sei();
  time_init();

  _delay_ms(2000);

  tx_puts("\r\nStarting\r\n");
  TEST_PROFILE(int16_t, delay())
  TEST_PROFILE(int16_t, iatan2(512, 124))
  TEST_PROFILE(int16_t, iatan2(512, -124))
  TEST_PROFILE(int16_t, iatan2(-512, -124))
  TEST_PROFILE(int16_t, iatan2(-512, 124))
  TEST_PROFILE(int16_t, iatan2(124, 2344))
  TEST_PROFILE(int16_t, iatan2(124, -2344))
  TEST_PROFILE(int16_t, iatan2(-124, -2344))
  TEST_PROFILE(int16_t, iatan2(-124, 2344))
  TEST_PROFILE(int16_t, isin1024(23))
  TEST_PROFILE(int16_t, isin1024(50))
  TEST_PROFILE(int16_t, iasin(181))  /* should get 32sliv = 45deg */
  for(angle = 0; angle < 256; angle++) {
    int16_t isin;
    isin = isin1024(angle);
    tx_puts("isin1024 "), tx_putdec(angle); tx_puts(" = ");
    tx_putdec(isin);
    tx_msg(" asin = ", iasin(isin));
  }
  for(angle = 0; angle < 256; angle++) {
    int16_t icos;
    icos = icos1024(angle);
    tx_puts("icos1024 "), tx_putdec(angle); tx_puts(" = ");
    tx_putdec(icos);
    tx_puts("\r\n");
  }
  TEST_PROFILE(uint16_t, isqrt(2181))
  TEST_PROFILE(uint16_t, isqrt(9181))

  for(angle = 0; angle < 256; angle++) {
    int16_t a;
    a = iatan2(tantab[angle].y, tantab[angle].x);
    tx_putdec(angle);
    tx_msg(" = ", a);
  }

  tx_puts("angle, sine, cosine\r\n");
  for (angle = 0; angle < 256; angle++) {
    int16_t s, c;
    s = isin1024(angle);
    c = icos1024(angle);
    tx_putdec(angle); tx_putc(' ');
    tx_putdec(s); tx_putc(' ');
    tx_putdec(c); tx_puts("\r\n");
  }

  for( ; ; );
}
